// Generated by CoffeeScript 1.6.3
(function() {
  var GenericSprite, Interaction, Rule, SpriteFactory, detectClick, detectDouble, detectDrag, detectDragEnd, touchDevice, _ref, _ref1,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  touchDevice = (_ref = typeof window.ontouchstart !== 'undefined') != null ? _ref : {
    "true": false
  };

  detectDrag = touchDevice != null ? touchDevice : {
    "touchmove": "drag"
  };

  detectDragEnd = touchDevice != null ? touchDevice : {
    "touchend": "dragend"
  };

  detectDouble = touchDevice != null ? touchDevice : {
    "dbltap": "dblclick"
  };

  detectClick = touchDevice != null ? touchDevice : {
    "tap": "click"
  };

  GenericSprite = (function(_super) {
    __extends(GenericSprite, _super);

    function GenericSprite(spriteId) {
      var hOff, imHeight, img, imgHeight, imgWidth, programming, shapeParams, tmpX, tmpY, wOff,
        _this = this;
      this.spriteId = spriteId;
      img = new Image();
      img.src = 'http://' + window.location.host + '/media/sprites/' + this.imageId + '.jpg';
      if (this.imageId !== void 0) {
        imgWidth = img.width;
        imHeight = img.height;
        wOff = img.width / 2;
        hOff = img.height / 2;
      } else {
        imgWidth = 100;
        imgHeight = 50;
        wOff = 50;
        hOff = 25;
      }
      shapeParams = {
        x: 50,
        y: 50,
        width: imgWidth,
        height: imgHeight,
        fill: 'black',
        image: img,
        strokeWidth: 0,
        draggable: true,
        offset: [wOff, hOff]
      };
      Kinetic.Image.call(this, shapeParams);
      programming = false;
      tmpX = 0;
      tmpY = 0;
      this.on('dblclick dbltap', function(event) {
        var dx, dy, myTransform, newRule;
        if (!programming) {
          console.log("remember this", _this.getAbsolutePosition().x, _this.getAbsolutePosition().y);
          tmpX = _this.getAbsolutePosition().x;
          tmpY = _this.getAbsolutePosition().y;
          _this.moveTo(rulesLayer);
        }
        if (programming) {
          newRule = new Rule();
          dx = _this.getAbsolutePosition().x - tmpX;
          dy = _this.getAbsolutePosition().y - tmpY;
          myTransform = {
            dx: dx,
            dy: dy
          };
          newRule.setTransform(myTransform);
          _this.addRule(newRule);
          console.log("analyze diff", tmpX, _this.getAbsolutePosition().x, tmpX - _this.getAbsolutePosition().x);
          _this.setPosition(tmpX, tmpY);
          _this.moveTo(layer);
        }
        rulesLayer.draw();
        programming = !programming;
        return console.log(programming);
      });
    }

    GenericSprite.prototype.applyRules = function(environment) {
      var rule, _i, _len, _ref1, _results;
      _ref1 = this._rules;
      _results = [];
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        rule = _ref1[_i];
        _results.push(rule.act(this, environment));
      }
      return _results;
    };

    GenericSprite.prototype.addRule = function(rule) {
      this._rules.push(rule);
      return this._rules.length - 1;
    };

    GenericSprite.prototype.setRule = function(index, rule) {
      if (this._rules[index] !== void 0) {
        return this._rules[index] = rule;
      } else {
        throw Error("The rule index " + index + " doesn't exist.");
      }
    };

    GenericSprite.prototype.applyTransform = function(transform) {
      var scale;
      this.setX(this.getX() + transform.dx);
      this.setY(this.getY() + transform.dy);
      this.rotate(transform.dr);
      scale = this.getScale();
      return this.setScale(scale.x * transform.dxScale, scale.y * transform.dyScale);
    };

    return GenericSprite;

  })(Kinetic.Image);

  SpriteFactory = function(spriteType, imageId) {
    var Sprite, _ref1;
    Sprite = (function(_super) {
      __extends(Sprite, _super);

      function Sprite() {
        _ref1 = Sprite.__super__.constructor.apply(this, arguments);
        return _ref1;
      }

      Sprite.prototype.spriteType = spriteType;

      Sprite.prototype.imageId = imageId;

      Sprite.prototype._rules = [];

      return Sprite;

    })(GenericSprite);
    return Sprite;
  };

  Rule = (function() {
    function Rule() {}

    Rule.prototype.setTransform = function(transform) {
      var defaultTransform, p, v;
      defaultTransform = {
        dx: 0,
        dy: 0,
        dr: 0,
        dxScale: 1,
        dyScale: 1
      };
      for (p in defaultTransform) {
        v = defaultTransform[p];
        if (!(p in transform)) {
          transform[p] = v;
        }
      }
      return this.transform = transform;
    };

    Rule.prototype.act = function(sprite, environment) {
      return sprite.applyTransform(this.transform);
    };

    return Rule;

  })();

  Interaction = (function(_super) {
    __extends(Interaction, _super);

    function Interaction() {
      _ref1 = Interaction.__super__.constructor.apply(this, arguments);
      return _ref1;
    }

    Interaction.prototype.setEnvironment = function(requiredEnvironment) {
      this.requiredEnvironment = requiredEnvironment;
    };

    Interaction.prototype.act = function(sprite, environment) {
      var minCount, shouldAct, spriteType, _ref2;
      shouldAct = true;
      _ref2 = this.requiredEnvironment;
      for (spriteType in _ref2) {
        minCount = _ref2[spriteType];
        if (!(spriteType in environment)) {
          shouldAct = false;
        } else if (environment[spriteType] < minCount) {
          shouldAct = false;
        }
      }
      if (shouldAct) {
        return sprite.applyTransform(this.transform);
      }
    };

    return Interaction;

  })(Rule);

  window.spriteList = [];

  window.spriteTypeList = [];

  window.tick = function() {
    var sprite, _i, _len, _ref2;
    _ref2 = window.spriteList;
    for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
      sprite = _ref2[_i];
      sprite.applyRules();
    }
    return window.layer.draw();
  };

  window.loadSpriteTypes = function() {
    var spriteTypeList;
    console.log("loading sprite types");
    spriteTypeList = [];
    return $("#sprite_drawer *").each(function(i, sprite) {
      spriteTypeList.push(SpriteFactory($(sprite).attr("data-frame-id"), $(sprite).attr("data-frame-id")));
      $(sprite).bind('dragend', function(e) {
        var newSprite;
        console.log("sprite ", $(sprite).attr("data-frame-id"), " added");
        newSprite = new spriteTypeList[i];
        console.log("dropped", e.originalEvent.clientX, e.originalEvent.clientY);
        newSprite.setPosition(e.originalEvent.clientX, e.originalEvent.clientY);
        layer.add(newSprite);
        spriteList.push(newSprite);
        layer.draw();
        e.stopPropagation();
        return e.preventDefault();
      });
      $(sprite).bind('touchend', function(e) {
        var newSprite;
        console.log("sprite ", $(sprite).attr("data-frame-id"), " added");
        newSprite = new spriteTypeList[i];
        console.log("dropped", e.originalEvent.clientX, e.originalEvent.clientY);
        newSprite.setPosition(e.originalEvent.clientX, e.originalEvent.clientY);
        layer.add(newSprite);
        spriteList.push(newSprite);
        layer.draw();
        e.stopPropagation();
        e.preventDefault();
        return alert(e.targetTouches[0].pageX);
      });
      $(sprite).bind('dbltap', function(e) {
        var newSprite;
        console.log("sprite ", $(sprite).attr("data-frame-id"), " added");
        newSprite = new spriteTypeList[i];
        layer.add(newSprite);
        spriteList.push(newSprite);
        layer.draw();
        e.stopPropagation();
        return e.preventDefault();
      });
      $(sprite).bind('dblclick', function(e) {
        var newSprite;
        console.log("sprite ", $(sprite).attr("data-frame-id"), " added");
        newSprite = new spriteTypeList[i];
        layer.add(newSprite);
        spriteList.push(newSprite);
        layer.draw();
        e.stopPropagation();
        return e.preventDefault();
      });
      $(sprite).bind('touchmove', function(e) {
        e.stopPropagation();
        return e.preventDefault();
      });
      return $(sprite).bind('touchstart', function(e) {
        e.stopPropagation();
        return e.preventDefault();
      });
    });
  };

  window.init = function() {
    var moveDown, moveRight, spin, stretchy;
    window.Star = SpriteFactory('Star');
    window.starA = new Star('A');
    window.spriteList.push(starA);
    layer.add(starA);
    stage.add(layer);
    moveRight = new Rule();
    moveRight.setTransform({
      dx: 10
    });
    moveDown = new Rule();
    moveDown.setTransform({
      dy: 10
    });
    spin = new Rule();
    spin.setTransform({
      dr: Math.PI / 6
    });
    stretchy = new Rule();
    stretchy.setTransform({
      dyScale: 1.1
    });
    return starA.addRule(stretchy);
  };

}).call(this);
